<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Game Room</title>
    <link rel="stylesheet" th:href="@{/stylesheets/style.css}">
    <script th:src="@{/javascripts/gameRoom.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h1>게임 방</h1>

<div id="room-info">
    <p>방 ID: <span id="room-id" th:text="${roomId}">ROOM1</span></p>
    <p>사용자: <span id="user-name" th:text="${#authentication?.name}">guest</span></p>
</div>

<div id="messages"></div>

<!-- 게임방 실시간 스크립트 -->
<script th:inline="javascript">
    // roomId는 쿼리스트링(param.roomId) 우선, 없으면 모델의 roomId 또는 기본값
    const roomId = /*[[${param.roomId} ?: ${roomId} ?: 'ROOM1']]*/ 'ROOM1';
    const user   = /*[[${#authentication?.name} ?: 'guest']]*/ 'guest';

    const sock  = new SockJS('/ws');
    const stomp = Stomp.over(sock);
    stomp.debug = null;

    function connect() {
      stomp.connect({}, onConnected, onError);
    }

    function onConnected() {
      // 해당 방에 구독
      stomp.subscribe('/topic/room/' + roomId, onMessage);

      // 방 참가 알림
      stomp.send('/app/room/join', {}, JSON.stringify({ roomId, user }));
    }

    function onError(err) {
      console.error('WS error:', err);
      setTimeout(connect, 2000); // 재연결 시도
    }

    function onMessage(frame) {
      const body = JSON.parse(frame.body);
      const div = document.getElementById("messages");
      const p = document.createElement("p");
      p.textContent = body.user + ": " + body.message;
      div.appendChild(p);
    }

    // 페이지 떠날 때 방 나가기
    window.addEventListener('beforeunload', () => {
      try {
        stomp.send('/app/room/leave', {}, JSON.stringify({ roomId, user }));
        stomp.disconnect(() => {}, {});
      } catch (e) {
        console.error(e);
      }
    });

    connect();
</script>

</body>
</html>
